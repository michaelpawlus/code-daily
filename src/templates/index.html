{% extends "base.html" %}

{% block title %}code-daily - @{{ username }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-2xl">
    <!-- Quick Stats Banner -->
    <header class="card rounded-xl p-4 mb-6">
        <div class="flex items-center justify-between">
            <!-- Left: App title and user -->
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-bold" style="color: var(--text-primary);">code-daily</h1>
                <span class="text-sm" style="color: var(--text-muted);">@{{ username }}</span>
            </div>

            <!-- Right: Quick stats and theme toggle -->
            <div class="flex items-center gap-4">
                <!-- Today's commits -->
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full {% if goal.met %}bg-green-500{% else %}bg-orange-500{% endif %}"></div>
                    <span class="text-sm font-medium" style="color: var(--text-secondary);">
                        {{ stats.today }} today
                    </span>
                </div>

                <!-- Current streak mini -->
                <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" style="color: var(--accent-streak);" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-sm font-bold" style="color: var(--accent-streak);">{{ streak.current }}</span>
                </div>

                <!-- Refresh button -->
                <button onclick="refreshData()" class="theme-toggle p-2 rounded-lg" aria-label="Refresh data" id="refresh-btn">
                    <svg id="refresh-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <svg id="refresh-spinner" class="w-5 h-5 hidden animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>

                <!-- Theme toggle -->
                <button onclick="toggleTheme()" class="theme-toggle p-2 rounded-lg" aria-label="Toggle theme">
                    <!-- Sun icon (shown in dark mode) -->
                    <svg id="sun-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                    <!-- Moon icon (shown in light mode) -->
                    <svg id="moon-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Streak Progress Ring (Hero Section) -->
    <section class="card rounded-xl p-8 mb-6 text-center">
        <!-- SVG Progress Ring -->
        <div class="relative inline-block mb-4">
            {% set streak_pct = [streak.current * 3.33, 100] | min %}
            {% if streak.current >= 30 %}
                {% set ring_class = "ring-animate" %}
                {% set gradient_id = "gradient-gold" %}
            {% elif streak.current >= 14 %}
                {% set ring_class = "" %}
                {% set gradient_id = "gradient-purple" %}
            {% elif streak.current >= 7 %}
                {% set ring_class = "" %}
                {% set gradient_id = "gradient-green" %}
            {% else %}
                {% set ring_class = "" %}
                {% set gradient_id = "gradient-teal" %}
            {% endif %}

            <svg class="w-48 h-48 {{ ring_class }}" viewBox="0 0 100 100">
                <defs>
                    <!-- Teal gradient (0-6 days) -->
                    <linearGradient id="gradient-teal" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#14b8a6"/>
                        <stop offset="100%" stop-color="#2dd4bf"/>
                    </linearGradient>
                    <!-- Green gradient (7-13 days) -->
                    <linearGradient id="gradient-green" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#14b8a6"/>
                        <stop offset="100%" stop-color="#22c55e"/>
                    </linearGradient>
                    <!-- Purple gradient (14-29 days) -->
                    <linearGradient id="gradient-purple" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#22c55e"/>
                        <stop offset="100%" stop-color="#a855f7"/>
                    </linearGradient>
                    <!-- Gold gradient (30+ days) -->
                    <linearGradient id="gradient-gold" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#a855f7"/>
                        <stop offset="50%" stop-color="#f59e0b"/>
                        <stop offset="100%" stop-color="#a855f7"/>
                    </linearGradient>
                </defs>

                <!-- Background circle -->
                <circle
                    cx="50" cy="50" r="42"
                    fill="none"
                    stroke="var(--bg-secondary)"
                    stroke-width="8"
                />

                <!-- Progress circle -->
                {% if streak.current > 0 %}
                <circle
                    cx="50" cy="50" r="42"
                    fill="none"
                    stroke="url(#{{ gradient_id }})"
                    stroke-width="8"
                    stroke-linecap="round"
                    stroke-dasharray="{{ 264 * (streak_pct / 100) }} 264"
                    transform="rotate(-90 50 50)"
                    class="{% if streak.current >= 30 %}ring-pulse{% endif %}"
                />
                {% endif %}
            </svg>

            <!-- Center content -->
            <div class="absolute inset-0 flex flex-col items-center justify-center">
                <div class="text-5xl font-bold" style="color: var(--accent-streak);">
                    {{ streak.current }}
                </div>
                <div class="text-sm" style="color: var(--text-muted);">day streak</div>
            </div>
        </div>

        <!-- Milestone Badge -->
        {% if streak.current >= 30 %}
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold text-white"
             style="background: linear-gradient(135deg, #a855f7 0%, #f59e0b 100%);"
             data-badge="on-fire">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            On Fire! 30+ days
        </div>
        {% elif streak.current >= 14 %}
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold"
             style="background-color: var(--accent-achievement); color: white;"
             data-badge="two-weeks">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Two Week Streak!
        </div>
        {% elif streak.current >= 7 %}
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold"
             style="background-color: var(--accent-goal); color: white;"
             data-badge="week">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Week Streak!
        </div>
        {% endif %}

        <!-- Streak warning -->
        {% if not streak.active and streak.current > 0 %}
        <div class="mt-4 flex items-center justify-center gap-2 text-sm" style="color: var(--accent-warning);">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            Commit today to keep your streak!
        </div>
        {% endif %}
    </section>

    <!-- Daily Goal Progress -->
    <section class="card rounded-xl p-6 mb-6" data-goal>
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Daily Goal</h2>
            <button onclick="toggleGoalForm()" class="text-sm hover:opacity-80 transition-opacity" style="color: var(--text-muted);" data-goal-edit-btn>
                Edit
            </button>
        </div>

        <!-- Goal Display -->
        <div data-goal-display>
            <!-- Progress Bar -->
            <div class="w-full rounded-full h-3 mb-3" style="background-color: var(--bg-secondary);">
                {% set progress_pct = (goal.today_progress / goal.daily * 100) | int %}
                {% set capped_pct = [progress_pct, 100] | min %}
                <div class="h-3 rounded-full transition-all duration-500 progress-animate"
                     style="width: {{ capped_pct }}%; background-color: {% if goal.met %}var(--accent-goal){% else %}var(--accent-warning){% endif %};"
                     data-goal-bar></div>
            </div>

            <!-- Progress Text -->
            <div class="flex items-center justify-between text-sm">
                <span style="color: var(--text-secondary);" data-goal-count>
                    {{ goal.today_progress }} / {{ goal.daily }} commit{% if goal.daily != 1 %}s{% endif %}
                </span>
                <span data-goal-status style="color: {% if goal.met %}var(--accent-goal){% else %}var(--accent-warning){% endif %};">
                    {% if goal.met %}
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Goal met!
                    </span>
                    {% else %}
                    {{ goal.daily - goal.today_progress }} more to reach your goal
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Goal Edit Form (hidden by default) -->
        <form onsubmit="saveGoal(event)" class="hidden" data-goal-form>
            <div class="flex items-center gap-3">
                <label for="goal-input" class="text-sm" style="color: var(--text-muted);">Commits per day:</label>
                <input type="number" id="goal-input" name="goal" min="1" max="100" value="{{ goal.daily }}"
                       class="input-field w-20 px-3 py-1 rounded text-center">
                <button type="submit" class="px-4 py-1 rounded text-white text-sm transition-opacity hover:opacity-90"
                        style="background-color: var(--accent-streak);">
                    Save
                </button>
                <button type="button" onclick="toggleGoalForm()" class="px-4 py-1 rounded text-sm transition-opacity hover:opacity-80"
                        style="background-color: var(--bg-secondary); color: var(--text-secondary);">
                    Cancel
                </button>
            </div>
        </form>
    </section>

    <!-- Today's Quests -->
    <section class="card rounded-xl p-6 mb-6" data-quests>
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Today's Quests</h2>
            <div class="flex items-center gap-3">
                <span class="text-sm" style="color: var(--text-muted);">
                    {{ quests.summary.completed }} completed
                </span>
                <button onclick="syncGitHubIssues()" class="text-sm px-3 py-1 rounded transition-opacity hover:opacity-90 flex items-center gap-1"
                        style="background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-card);"
                        id="sync-github-btn" title="Sync issues assigned to you from GitHub">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    <span id="sync-github-text">Sync Issues</span>
                </button>
                <button onclick="scanTodos()" class="text-sm px-3 py-1 rounded transition-opacity hover:opacity-90 flex items-center gap-1"
                        style="background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-card);"
                        id="scan-todos-btn" title="Scan for TODO/FIXME comments in code">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z"/>
                    </svg>
                    <span id="scan-todos-text">Scan TODOs</span>
                </button>
                <button onclick="discoverExternal()" class="text-sm px-3 py-1 rounded transition-opacity hover:opacity-90 flex items-center gap-1"
                        style="background-color: var(--accent-achievement); color: white;"
                        id="discover-external-btn" title="Find good first issues in your starred repos">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                    <span id="discover-external-text">Discover</span>
                </button>
                <button onclick="toggleQuestForm()" class="text-sm px-3 py-1 rounded transition-opacity hover:opacity-90"
                        style="background-color: var(--accent-streak); color: white;" data-quest-add-btn>
                    + Add Quest
                </button>
            </div>
        </div>

        <!-- Add Quest Form (hidden by default) -->
        <form onsubmit="addQuest(event)" class="hidden mb-4 p-4 rounded-lg" style="background-color: var(--bg-secondary);" data-quest-form>
            <div class="space-y-3">
                <div>
                    <input type="text" id="quest-title" name="title" placeholder="What do you want to work on?"
                           class="input-field w-full px-3 py-2 rounded" required>
                </div>
                <div>
                    <textarea id="quest-description" name="description" placeholder="Optional description..."
                              class="input-field w-full px-3 py-2 rounded resize-none" rows="2"></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="px-4 py-2 rounded text-white text-sm transition-opacity hover:opacity-90"
                            style="background-color: var(--accent-streak);">
                        Add Quest
                    </button>
                    <button type="button" onclick="toggleQuestForm()" class="px-4 py-2 rounded text-sm transition-opacity hover:opacity-80"
                            style="background-color: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-card);">
                        Cancel
                    </button>
                </div>
            </div>
        </form>

        <!-- Active Quests -->
        {% if quests.active %}
        <div class="mb-4">
            <h3 class="text-sm font-medium mb-2" style="color: var(--accent-goal);">In Progress</h3>
            <div class="space-y-2 quest-list-scroll">
                {% for quest in quests.active %}
                <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--bg-secondary); border-left: 3px solid var(--accent-goal);">
                    <div class="flex-1">
                        <div class="font-medium" style="color: var(--text-primary);">{{ quest.title }}</div>
                        {% if quest.description %}
                        <div class="text-sm mt-1" style="color: var(--text-muted);">{{ quest.description }}</div>
                        {% endif %}
                    </div>
                    <button onclick="completeQuest({{ quest.id }})"
                            class="ml-3 px-3 py-1 rounded text-sm font-medium transition-opacity hover:opacity-90"
                            style="background-color: var(--accent-goal); color: white;">
                        Complete
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Pending Quests -->
        {% if quests.pending %}
        <div class="space-y-2 quest-list-scroll" data-quest-list>
            {% for quest in quests.pending %}
            <div class="flex items-center justify-between p-3 rounded-lg quest-item" style="background-color: var(--bg-secondary);" data-quest-id="{{ quest.id }}">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="font-medium" style="color: var(--text-primary);">{{ quest.title }}</span>
                        {% if quest.source == 'github_issue' %}
                        <a href="{{ quest.source_ref }}" target="_blank" rel="noopener noreferrer"
                           class="text-xs px-2 py-0.5 rounded flex items-center gap-1 transition-opacity hover:opacity-80"
                           style="background-color: #24292e; color: white;"
                           title="View on GitHub">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            GitHub
                        </a>
                        {% elif quest.source == 'todo_scan' %}
                        <button onclick="copySourceRef('{{ quest.source_ref }}')"
                           class="text-xs px-2 py-0.5 rounded flex items-center gap-1 transition-opacity hover:opacity-80"
                           style="background-color: var(--accent-warning); color: white;"
                           title="Click to copy {{ quest.source_ref }}">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                            </svg>
                            {{ quest.source_ref }}
                        </button>
                        {% elif quest.source == 'external' %}
                        <a href="{{ quest.source_ref }}" target="_blank" rel="noopener noreferrer"
                           class="text-xs px-2 py-0.5 rounded flex items-center gap-1 transition-opacity hover:opacity-80"
                           style="background-color: var(--accent-achievement); color: white;"
                           title="External contribution opportunity - View on GitHub">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                            </svg>
                            Contribute
                        </a>
                        {% else %}
                        <span class="text-xs px-2 py-0.5 rounded" style="background-color: var(--bg-card); color: var(--text-muted);">
                            {{ quest.source }}
                        </span>
                        {% endif %}
                    </div>
                    {% if quest.description %}
                    <div class="text-sm mt-1" style="color: var(--text-muted);">{{ quest.description }}</div>
                    {% endif %}
                </div>
                <div class="flex items-center gap-2 ml-3">
                    <button onclick="acceptQuest({{ quest.id }})"
                            class="px-3 py-1 rounded text-sm font-medium transition-opacity hover:opacity-90"
                            style="background-color: var(--accent-streak); color: white;">
                        Start
                    </button>
                    <button onclick="showSkipOptions({{ quest.id }})"
                            class="px-3 py-1 rounded text-sm transition-opacity hover:opacity-80"
                            style="background-color: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border-card);">
                        Skip
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        {% if not quests.active %}
        <div class="text-center py-8" style="color: var(--text-muted);">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
            </svg>
            <p class="text-sm">No quests yet. Add one to get started!</p>
        </div>
        {% endif %}
        {% endif %}

        <!-- Quick Add Idea -->
        <div class="mt-4 pt-4" style="border-top: 1px solid var(--border-card);">
            <form onsubmit="addIdea(event)" class="flex gap-2">
                <input type="text" id="idea-input" name="content" placeholder="Quick idea..."
                       class="input-field flex-1 px-3 py-2 rounded text-sm">
                <button type="submit" class="px-4 py-2 rounded text-sm transition-opacity hover:opacity-90"
                        style="background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-card);">
                    Save Idea
                </button>
            </form>
        </div>
    </section>

    <!-- Skip Quest Modal -->
    <div id="skip-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background-color: rgba(0,0,0,0.5);">
        <div class="card rounded-xl p-6 max-w-sm mx-4" style="background-color: var(--bg-card);">
            <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Skip Quest</h3>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">What would you like to do with this quest?</p>
            <div class="space-y-2">
                <button onclick="skipQuest('archive', false)" class="w-full p-3 rounded-lg text-left transition-opacity hover:opacity-80"
                        style="background-color: var(--bg-secondary); color: var(--text-primary);">
                    <div class="font-medium">Archive</div>
                    <div class="text-xs" style="color: var(--text-muted);">Remove from queue, won't resurface</div>
                </button>
                <button onclick="skipQuest('skip', true)" class="w-full p-3 rounded-lg text-left transition-opacity hover:opacity-80"
                        style="background-color: var(--bg-secondary); color: var(--text-primary);">
                    <div class="font-medium">Save as Idea</div>
                    <div class="text-xs" style="color: var(--text-muted);">Save to IDEAS.md for later</div>
                </button>
                <button onclick="hideSkipModal()" class="w-full p-3 rounded-lg text-center transition-opacity hover:opacity-80"
                        style="color: var(--text-muted);">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card stat-card rounded-xl p-4 text-center">
            <div class="text-2xl font-bold" style="color: var(--text-primary);">{{ stats.this_week }}</div>
            <div class="text-sm" style="color: var(--text-muted);">This Week</div>
        </div>
        <div class="card stat-card rounded-xl p-4 text-center">
            <div class="text-2xl font-bold" style="color: var(--text-primary);">{{ stats.this_month }}</div>
            <div class="text-sm" style="color: var(--text-muted);">This Month</div>
        </div>
        <div class="card stat-card rounded-xl p-4 text-center">
            <div class="text-2xl font-bold" style="color: var(--text-primary);">{{ stats.total }}</div>
            <div class="text-sm" style="color: var(--text-muted);">Total</div>
        </div>
        <div class="card stat-card rounded-xl p-4 text-center">
            <div class="text-2xl font-bold" style="color: var(--text-primary);">{{ streak.longest }}</div>
            <div class="text-sm" style="color: var(--text-muted);">Best Streak</div>
        </div>
    </section>

    <!-- Activity History Heatmap -->
    <section class="card rounded-xl p-6 mb-6" data-heatmap>
        <h2 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Activity History</h2>
        <div class="heatmap-grid overflow-x-auto">
            <!-- Day labels -->
            <div class="heatmap-labels">
                <span></span>
                <span>Mon</span>
                <span></span>
                <span>Wed</span>
                <span></span>
                <span>Fri</span>
                <span></span>
            </div>
            <!-- Heatmap cells -->
            <div class="heatmap-cells">
                {% for day in history.days %}
                <div class="heatmap-cell level-{{ day.level }}"
                     data-date="{{ day.date }}"
                     data-count="{{ day.count }}"
                     title="{{ day.date }}: {{ day.count }} commit{% if day.count != 1 %}s{% endif %}">
                </div>
                {% endfor %}
            </div>
        </div>
        <!-- Legend -->
        <div class="flex items-center justify-end gap-2 mt-4 text-xs" style="color: var(--text-muted);">
            <span>Less</span>
            <div class="heatmap-cell level-0"></div>
            <div class="heatmap-cell level-1"></div>
            <div class="heatmap-cell level-2"></div>
            <div class="heatmap-cell level-3"></div>
            <div class="heatmap-cell level-4"></div>
            <span>More</span>
        </div>
    </section>

    <!-- Achievements Section -->
    <section class="card rounded-xl p-6 mb-6" data-achievements>
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Achievements</h2>
            {% set unlocked_count = achievements | selectattr('unlocked') | list | length %}
            <span class="text-sm" style="color: var(--accent-achievement);" data-achievements-progress>
                {{ unlocked_count }} / {{ achievements | length }} unlocked
            </span>
        </div>

        <!-- Achievements Grid -->
        <div class="grid grid-cols-5 gap-3" data-achievements-grid>
            {% for achievement in achievements %}
            <div class="relative group p-3 rounded-lg text-center transition-all duration-200
                        {% if achievement.unlocked %}achievement-unlocked hover:scale-105{% else %}achievement-locked{% endif %}"
                 data-achievement-id="{{ achievement.id }}"
                 data-unlocked="{{ 'true' if achievement.unlocked else 'false' }}">
                <!-- Emoji -->
                <div class="text-2xl mb-1 {% if not achievement.unlocked %}grayscale{% endif %}">
                    {{ achievement.emoji }}
                </div>
                <!-- Name -->
                <div class="text-xs font-medium truncate"
                     style="color: {% if achievement.unlocked %}var(--text-primary){% else %}var(--text-muted){% endif %};">
                    {{ achievement.name }}
                </div>

                <!-- Tooltip -->
                <div class="absolute z-10 invisible group-hover:visible opacity-0 group-hover:opacity-100
                            transition-opacity duration-200 bottom-full left-1/2 transform -translate-x-1/2 mb-2
                            text-xs rounded-lg p-3 w-48 shadow-lg"
                     style="background-color: var(--bg-card); border: 1px solid var(--border-card); color: var(--text-primary);">
                    <div class="font-semibold mb-1">{{ achievement.name }}</div>
                    <div class="mb-1" style="color: var(--text-secondary);">{{ achievement.description }}</div>
                    {% if achievement.unlocked %}
                    <div style="color: var(--accent-goal);" class="text-xs">
                        Unlocked: {{ achievement.unlocked_at[:10] if achievement.unlocked_at else 'Unknown' }}
                    </div>
                    {% else %}
                    <div style="color: var(--text-muted);" class="text-xs">Locked</div>
                    {% endif %}
                    <!-- Tooltip arrow -->
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-8 border-transparent"
                         style="border-top-color: var(--border-card);"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Footer -->
    <footer class="text-center text-sm" style="color: var(--text-muted);">
        {% if streak.last_commit_date %}
        <p>Last commit: {{ streak.last_commit_date }}</p>
        {% else %}
        <p>No commits yet</p>
        {% endif %}
    </footer>
</div>
{% endblock %}
